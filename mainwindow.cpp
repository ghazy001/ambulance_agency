#include "mainwindow.h"
#include "equipement.h"
#include <QMessageBox>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QSqlQuery>
#include <QPixmap>
#include<QImage>
#include <QSystemTrayIcon>
#include <QSystemTrayIcon>

#include <QPixmap>
#include<QImage>

#include "ui_mainwindow.h"
#include <QMessageBox>
#include "connection.h"
#include <QDate>
#include <QString>
#include <QIntValidator>
#include <QLineEdit>
#include <QRegExpValidator>
#include <QSystemTrayIcon>


#include <QMessageBox>
#include "connection.h"
#include <QDate>
#include <QString>
#include <QIntValidator>
#include <QLineEdit>
#include <QRegExpValidator>
#include <QSystemTrayIcon>

#include<QPdfWriter>
#include<QPainter>
#include<QPixmap>
#include<QPrinter>
#include<QTextStream>
#include<QTextDocument>
#include<QFileDialog>
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>




#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>

#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>
#include <QMovie>

#include<QLabel>
#include"QMessageBox"
#include <QPdfWriter>
#include <QtGui/QDesktopServices>
#include <QUrl>
#include <QIntValidator>
#include <QMessageBox>
#include <QSqlQuery>
#include <QPrinter>
#include <QPrintDialog>
#include <QtSvg/QSvgRenderer>
#include <QFileDialog>
#include <fstream>
#include "QrCode.hpp"
#include <QAxObject>
#include <QObject>
#include <QDesktopServices>
#include"QrCode.hpp"

#include <QIntValidator>
#include <QTableView>
#include <QMessageBox>
#include <QPixmap>
#include<QPrinter>
#include<QPainter>
#include<QPrintDialog>
#include <QPrintPreviewDialog>
#include <QPdfWriter>
#include <QtCharts>
#include <QDesktopServices>
#include <QtCharts/QAreaSeries>
#include <QtCharts/QChartView>
#include <QtCharts/QLineSeries>
#include <QPieSlice>
#include <QPieSeries>
#include <QChartView>

#include <QPrintDialog>
#include <QFileDialog>




#include <QMessageBox>
#include "connection.h"
#include <QDate>
#include <QString>
#include <QIntValidator>
#include <QLineEdit>
#include <QRegExpValidator>
#include <QSystemTrayIcon>

#include<QPdfWriter>
#include<QPainter>
#include<QPixmap>
#include<QPrinter>
#include<QTextStream>
#include<QTextDocument>
#include<QFileDialog>
#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>




#include <QMessageBox>
#include<QIntValidator>
#include <QApplication>
#include<QSound>
#include<QDebug>
#include<QMediaPlayer>
#include <QPrinter>
#include <QTextStream>
#include <QTextDocument>
#include <QDataStream>
#include <QPrintDialog>
#include <QSqlQuery>
#include<QComboBox>
#include<QSaveFile>
#include<QBuffer>
#include<QFileDialog>
#include<QFile>
#include <QMessageBox>
#include <QDebug>
#include <QIntValidator>
#include <QSqlQueryModel>
#include <QtCharts>
#include <QChartView>
#include <QLineSeries>
#include<QDesktopServices>
#include<QUrl>
#include <QTextStream>
#include <QTextDocument>
#include <QtPrintSupport/QPrintDialog>
#include <QtPrintSupport/QPrinter>
#include <QtWidgets>
#include<QFileDialog>

#include<QGraphicsView>
#include<QPdfWriter>
#include<QSqlQuery>
#include<QSystemTrayIcon>
#include <QtNetwork/QAbstractSocket>
#include <QtNetwork/QSslSocket>
#include<QUrlQuery>
#include<QJsonDocument>
#include<QJsonObject>
#include<QJsonArray>
#include <QDate>
#include <QTime>
#include<QSqlTableModel>
#include<QItemSelectionModel>
#include<QTableWidgetItem>
#include <QDesktopWidget>
#include <QCoreApplication>
#include <QDateEdit>
#include <QComboBox>
#include <QPixmap>
#include <QMediaPlayer>
#include <QTabWidget>
#include <QObject>
#include <QDialog>
#include <QValidator>
#include <QPropertyAnimation>
#include <QEasingCurve>
#include <QSequentialAnimationGroup>
#include <QState>
#include <QStateMachine>
#include <QSignalTransition>
#include <QPainter>
#include<QString>
#include<QStatusBar>

#include <QtCharts/QChartView>
#include <QtCharts/QPieSeries>
#include <QtCharts/QPieSlice>
#include <QGridLayout>
#include <QtCharts>
#include <QChartView>
#include <QStackedWidget>

using qrcodegen::QrCode;
using qrcodegen::QrSegment;


using namespace qrcodegen;


#include "Result.h"
#include "Operation.h"

#include "mainwindow.h"
#include "ui_mainwindow.h"

#include <QToolTip>
MainWindow::MainWindow(QWidget *parent) :
    QMainWindow(parent),
    ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    ui->tab_equipement->setModel(eq.afficher());
    ui->id_e->setValidator(new QIntValidator(0, 9999999, this));
    ui->prix_e->setValidator(new QIntValidator(0, 10000, this));
    ui->id_e_2->setValidator(new QIntValidator(0, 9999999, this));
    ui->prix_e_2->setValidator(new QIntValidator(0, 10000, this));
    QRegExp
    regExp("^[A-Za-z]*$");
    ui->nom_e->setValidator(new QRegExpValidator(regExp, this));
    ui->nom_e_2->setValidator(new QRegExpValidator(regExp, this));


    QChart *chart=new QChart();
    chart =eq.statistique_chart();
    QChartView * ChartView=new QChartView(chart,ui->stats);
    ChartView->resize(420,360);
    ChartView->setRenderHint(QPainter::Antialiasing);


}

MainWindow::~MainWindow()
{
    delete ui;

}


void MainWindow::on_ajouter_e_clicked()
{
    int id_equipement=ui->id_e->text().toInt();
    ui->tab_equipement->setModel(eq.afficher());
        QString reference=ui->ref_e->text();
       int prix=ui->prix_e->text().toInt();
        QString nom_equipement=ui->nom_e->text();

        equipement eq(id_equipement,reference,prix,nom_equipement);
        bool test=eq.ajouter();
        if(test)
       {
            ui->tab_equipement->setModel(eq.afficher());

/*
         QMessageBox::information(nullptr, QObject::tr("oui"),
         QObject::tr("ajout effectuee.\n"
                     "Click Cancel to exit."), QMessageBox::Cancel);

*/
on_pushButton_success_clicked();



       }
        else {/*
            QMessageBox::critical(nullptr, QObject::tr("non"),
            QObject::tr("ajout non effectuee.\n"
                       "Click Cancel to exit."), QMessageBox::Cancel);*/
            on_pushButton_error_clicked();
}
}
void MainWindow::on_pushButton_success_clicked()
{
    NotificationParams params;
    params.title = "Equipement a ete ajoute avec succès";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_pushButton_error_clicked()
{
    NotificationParams params;
    params.title = "Equipement n'est pas ajoute";
    params.message = Operation::DoSomething(Result::RESULT_ERROR);

    notificationLayout.AddNotificationWidget(this, params);
}


void MainWindow::on_supprimer_e_clicked()
{ equipement eq;
    eq.setid_equipement(ui->id_e_s->text().toInt());
   //int id_equipement =ui->id_e_s->text().toInt();

       bool test=eq.supprimer(eq.getid_equipement());
       if(test)
      {
                       ui->tab_equipement->setModel(eq.afficher());


         on_pushButton_success1_clicked();
         }
       else{

         on_pushButton_error1_clicked();
}
}

void MainWindow::on_pushButton_success1_clicked()
{
    NotificationParams params;
    params.title = "Equipement a ete supprimer avec succès";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_pushButton_error1_clicked()
{
    NotificationParams params;
    params.title = "suppression non effectue";
    params.message = Operation::DoSomething(Result::RESULT_ERROR);

    notificationLayout.AddNotificationWidget(this, params);
}


void MainWindow::on_pushButton_2_clicked()
{int id_equipement=ui->id_e_2->text().toInt();

    QString reference=ui->ref_e_2->text();
    int prix=ui->prix_e_2->text().toInt();
    QString nom_equipement=ui->nom_e_2->text();
     equipement eq(id_equipement,reference,prix,nom_equipement);

    bool test= eq.modifier();
    if(test)
   {
                    ui->tab_equipement->setModel(eq.afficher());


      on_pushButton_success2_clicked();
       }
    else{

    on_pushButton_error2_clicked();
    }
}


void MainWindow::on_pushButton_success2_clicked()
{
    NotificationParams params;
    params.title = "Equipement a ete modifier avec succès";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_pushButton_error2_clicked()
{
    NotificationParams params;
    params.title = "modification non effectue";
    params.message = Operation::DoSomething(Result::RESULT_ERROR);

    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_tab_equipement_clicked(const QModelIndex &index)
{
    {
        int val=ui->tab_equipement->model()->data(index).toInt();
        QString val_string=QString::number(val);
            QSqlQuery qry;

            qry.prepare("select * from EQUIPEMENT where ID_EQUIPEMENT=:v ");
            qry.bindValue(":v",val_string);
            if(qry.exec())
            {
                while(qry.next())
                {
                    ui->id_e_2->setText(qry.value(0).toString());
                    ui->ref_e_2->setText(qry.value(2).toString());
                    ui->prix_e_2->setText(qry.value(3).toString());
                    ui->nom_e_2->setText(qry.value(4).toString());
                    ui->id_e_s->setText(qry.value(0).toString());

                }

            }
            else
            {
                QMessageBox::critical(nullptr, QObject::tr("selection n'est pas effuctué"),  QObject::tr("connection failed.\n" "Click Cancel to exit."), QMessageBox::Cancel);
            }
}
}


void MainWindow::on_pushButton_success3_clicked()
{
    NotificationParams params;
    params.title = "Tri effectué avec succès ";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_pushButton_success4_clicked()
{
    NotificationParams params;
    params.title = "Qr Code effectué avec succès ";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}

void MainWindow::on_lineEditchercher_cursorPositionChanged(int arg1, int arg2)
{

        ui->tab_equipement->setModel(eq.rechercher(ui->lineEditchercher->text()));

            QString test =ui->lineEditchercher->text();

            if(test=="")
            {
                ui->tab_equipement->setModel(eq.afficher());//refresh
            }
    }

void MainWindow::on_pushButton_error5_clicked()
{
    NotificationParams params;
    params.title = "Qr Code non efféctue L'équipement n'existe pas";
    params.message = Operation::DoSomething(Result::RESULT_ERROR);

    notificationLayout.AddNotificationWidget(this, params);
}
void MainWindow::on_qrcodegen_3_clicked()
{

        using namespace qrcodegen;

        QString value = ui->lineEdit_qrcode_3->text();

        QSqlQuery qry;
        if (qry.prepare("SELECT * FROM Equipement WHERE id_equipement = :id_equipement")) {
            qry.bindValue(":id_equipement", value);
            if (qry.exec() && qry.next()) {
                QString id_equipement = qry.value(0).toString().simplified();
                QString reference = qry.value(1).toString().simplified();
                QString prix = qry.value(2).toString().simplified();
                QString nom_equipement = qry.value(3).toString().simplified();

                QString text = "id equipement =" + id_equipement + "\n"
                               + "reference =" + reference + "\n"
                               + "prix =" + prix + "\n"
                               + "nom equipement =" + nom_equipement + "\n";

                // Create the QR Code object
                QrCode qr = QrCode::encodeText(text.toUtf8().data(), QrCode::Ecc::MEDIUM);

                qint32 sz = qr.getSize();
                QImage im(sz, sz, QImage::Format_RGB32);
                QRgb black = qRgb(191, 112, 105);
                QRgb white = qRgb(255, 255, 255);
                for (int y = 0; y < sz; y++) {
                    for (int x = 0; x < sz; x++) {
                        im.setPixel(x, y, qr.getModule(x, y) ? black : white); //setpixelmap tafichilek qr code
                    }
                }
                ui->qrcodecommande_3->setPixmap(QPixmap::fromImage(im.scaled(200, 200, Qt::KeepAspectRatio, Qt::FastTransformation), Qt::MonoOnly));
                on_pushButton_success4_clicked();
            } else {
on_pushButton_error5_clicked();            }
        } else {
            QMessageBox::critical(this, tr("Erreur"), qry.lastError().text());
        }
    }

void MainWindow::on_comboBox_activated(const QString &arg1)
{
    if (arg1=="id_equipement")
            ui->tab_equipement->setModel(eq.trier(1));
        if (arg1=="reference")
            ui->tab_equipement->setModel(eq.trier(2));
        if (arg1=="prix")
            ui->tab_equipement->setModel(eq.trier(3));
}

void MainWindow::on_pushButton_3_clicked()
{

        /*QString currentDir = QDir::currentPath();
        qDebug() << "Répertoire de travail actuel : " << currentDir;*/

        QString fileName = QFileDialog::getSaveFileName((QWidget* )0, "Export PDF", QString(), "*.pdf");
        if (QFileInfo(fileName).suffix().isEmpty())
        {
            fileName.append(".pdf");
        }
        QPrinter printer(QPrinter::PrinterResolution);
        printer.setOutputFormat(QPrinter::PdfFormat);
        printer.setPaperSize(QPrinter::A4);
        printer.setOutputFileName(fileName);
        QTextDocument doc;
        QPdfWriter pdf(fileName);
        QPainter painter(&pdf);
        int i = 4000;

        // Charger l'image de logo

    QPixmap logo("images/Capture d’écran 2023-04-02 215328.png");
    QImage signature("images/signature.png");
        // Redimensionner l'image si nécessaire
        logo = logo.scaledToWidth(1000, Qt::SmoothTransformation);
        if (logo.isNull())
        {
            qDebug() << "Erreur : impossible de charger le logo";
        }

        if (signature.isNull())
        {
            qDebug() << "Erreur : impossible de charger la signature";
        }

        qDebug() << logo.size();
         qDebug() << signature.size();
        // Dessiner le logo en haut à gauche de la page

    painter.drawPixmap(82000,2000,logo.scaled(QSize(1000, 626), Qt::KeepAspectRatio, Qt::SmoothTransformation));
    logo = logo.scaled(QSize(1000, 626), Qt::IgnoreAspectRatio, Qt::SmoothTransformation);


    if (painter.device()->paintingActive() && logo.isNull())
    {
        qDebug() << "Erreur : impossible de dessiner le logo";
    }
        painter.setPen(Qt::blue);//titre
        painter.setFont(QFont("Cambria", 30));
        painter.drawText(1700,1200,"LISTES DES EQUIPEMENTS");

        painter.setPen(Qt::black);
        painter.setFont(QFont("Cambria",14));
        painter.drawRect(0,3000,9600,500);
        painter.setFont(QFont("Cambria",11));
        painter.drawText(200,3300,"ID_EQUIPEMENT ");
        painter.drawText(1800,3300, "REFERENCE");
        painter.drawText(3000,3300,"PRIX");
        painter.drawText(4500,3300,"NOM_EQUIPEMENT ");


        // Get the current date and format it as a string
        QDateTime currentDate = QDateTime::currentDateTime();
        QString dateString = currentDate.toString("dd/MM/yyyy");

        // Draw the current date at the top-right corner of the page
        painter.setFont(QFont("Cambria",11));
        painter.drawText(8200,2000, dateString);

        QSqlQuery query;
        query.prepare("select * from EQUIPEMENT");
        query.exec();
        while (query.next())
        {
            painter.drawText(200,i,query.value(0).toString());
            painter.drawText(1800,i,query.value(1).toString());
            painter.drawText(3000,i,query.value(2).toString());
            painter.drawText(4500,i,query.value(3).toString());

            i = i + 500;

            QImage image(":/new/prefix7/AAAA.png");
                        painter.drawImage(QRect(100, 100, 600, 600), image);
        }

        doc.print(&printer);


on_pushButton_success10_clicked();

}
void MainWindow::on_pushButton_success10_clicked()
{
    NotificationParams params;
    params.title = "export PDF avec succes";
    params.message = Operation::DoSomething(Result::RESULT_SUCCESS);
    notificationLayout.AddNotificationWidget(this, params);
}
